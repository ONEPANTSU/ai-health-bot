# AI Health Bot

## О проекте
Telegram-бот на aiogram, который ведёт пользователя по 28‑дневной программе самоконтроля здоровья: собирает анкеты и медиа (фото/видео), хранит данные в Postgres + S3 и может подключать GPT‑4o для персональных рекомендаций и ежедневных/недельных отчётов.

## Основные возможности
- Анкеты: приветствие, ежедневная, питание, БАДы, поддержка/безопасность, субъективное здоровье, осознанность, окружение, телосложение.
- Медиа‑задания: фото/видео (лицо, стопы, полный рост, баланс, бег, приседания, дыхание, язык, речь, реакция и др.) с проверкой количества и инструкциями.
- Планировщик (APS): часовые проверки, учёт часового пояса, рассылка заданий по дням программы и напоминания об ежедневной анкете.
- AI‑аналитика (подготовлено): GPT‑4o анализирует ответы и изображения, сохраняет выводы; отправка пользователю и недельные дайджесты пока отключены флагом.
- Хранилище: ответы и ссылки на медиа в `patient_history`, пользователи в `patients`, промпты/ответы LLM в `llm_responses`.
- Продакшн: используется в клинике (Самара).

## Архитектура кратко
- `src/main.py` — регистрация команд, подключение роутеров, запуск polling.
- `src/bot/handlers/*` — сценарии анкет и медиа‑заданий (FSM aiogram).
- `src/bot/scheduler.py` — расписание рассылок и проверок.
- `src/llm/service.py` — подготовка промптов, подтягивание медиa из S3, вызовы GPT‑4o.
- `src/media/s3_client.py` — загрузка/выдача файлов S3, presigned URLs, Base64 для LLM.
- `src/db/*` — asyncpg соединение, репозиторий и модели, Alembic миграции.

## Стек
- Python, aiogram, APScheduler, asyncpg, aiobotocore (S3), LangChain + OpenAI GPT‑4o, Alembic, Postgres.

## Переменные окружения
Создайте `.env` (пример):
```
BOT_TOKEN=...
OPENAI_API_KEY=...
POSTGRES_DSN=postgresql://user:pass@host:5432/db
S3_URL=...
S3_BUCKET=...
S3_ACCESS_KEY=...
S3_SECRET_KEY=...
```

## Запуск
```sh
make docker-run
```

## Ключевые команды бота
- `/start` — регистрация, установка команд.
- `/set_timezone` — часовой пояс.
- `/daily` — ежедневная анкета.
- `/greeting`, `/nutrition`, `/supplements`, `/safety`, `/subjective_health`, `/mindfulness`, `/close_environment`, `/body_measurements`.
- Медиа‑таски: `/face`, `/eye`, `/tongue`, `/hands`, `/feet`, `/full_body`, `/balance`, `/plank`, `/running`, `/squats`, `/walking`, `/neck`, `/picking_up`, `/breathing`, `/rest_breathing`, `/pressure`, `/speach`, `/reaction`, `/blood`, `/checkups`, `/feedback`.

## Рассылка и BDD‑логика
- Расписание опирается на глобальную дату старта тестирования и часовой пояс пациента; задания раскиданы по дням (1–28).
- Проверка заполнения ежедневной анкеты — если нет записи за локальный день, отправляется напоминание.
- LLM‑ответы сохраняются отдельно и могут использоваться для ежедневных/недельных дайджестов .
